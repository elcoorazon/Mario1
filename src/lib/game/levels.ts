import type { Collectible, Enemy, MovingPlatform } from './entities';

export interface LevelDefinition {
  id: number;
  name: string;
  width: number;
  height: number;
  tiles: number[][]; // 0 empty, 1 solid, 2 spike
  playerSpawn: { x: number; y: number };
  exit: { x: number; y: number; w: number; h: number };
  enemies: Enemy[];
  collectibles: Collectible[];
  movingPlatforms: MovingPlatform[];
  timeTarget: number;
}

const fromAscii = (rows: string[]) => {
  const tiles: number[][] = rows.map((r) =>
    r.split('').map((c) => {
      if (c === '#') return 1;
      if (c === '^') return 2;
      return 0;
    })
  );

  const enemies: Enemy[] = [];
  const collectibles: Collectible[] = [];
  let playerSpawn = { x: 24, y: 24 };
  let exit = { x: rows[0].length * 16 - 36, y: 16, w: 20, h: 28 };

  rows.forEach((row, y) => {
    row.split('').forEach((cell, x) => {
      const px = x * 16;
      const py = y * 16;
      if (cell === 'P') playerSpawn = { x: px, y: py };
      if (cell === 'X') exit = { x: px, y: py - 12, w: 20, h: 28 };
      if (cell === 'E' || cell === 'H') {
        enemies.push({
          id: `enemy-${x}-${y}`,
          x: px,
          y: py,
          w: 12,
          h: 12,
          vx: 0,
          vy: 0,
          grounded: false,
          type: cell === 'E' ? 'patrol' : 'hopper',
          direction: 1,
          speed: cell === 'E' ? 52 : 62,
          alive: true,
          aiTimer: 0
        });
      }
      if (cell === 'C' || cell === 'S') {
        collectibles.push({
          id: `collect-${x}-${y}`,
          x: px + 8,
          y: py + 8,
          radius: 5,
          value: cell === 'S' ? 250 : 100,
          collected: false,
          pulse: Math.random() * Math.PI,
          secret: cell === 'S'
        });
      }
    });
  });

  return { tiles, enemies, collectibles, playerSpawn, exit };
};

const levelAscii = [
  {
    name: 'Copper Meadow',
    timeTarget: 70,
    map: [
      '....................................................................................................',
      '....................................................................................................',
      '....................................................................................................',
      '....C..............C..................S....................C...................................X...',
      '................########...........#####.........................................####..............',
      '..P......####..................E....................H..............................................',
      '########.......C..............#####.................#####..........C...............................',
      '...............####...........................####....................####.........................',
      '......^^^^.........................^^^^...............................................^^^^..........',
      '################....#############################....##########################....################'
    ],
    movingPlatforms: [] as MovingPlatform[]
  },
  {
    name: 'Neon Caverns',
    timeTarget: 85,
    map: [
      '................................................................................................................',
      '................................................................................................................',
      '......S...............C....................................................C....................................',
      '.............#####....................#####......................#####.....................####............X....',
      '...P...........................E...................................................H............................',
      '#########...........C.....................####.......C...................####...................................',
      '.........................####............................####.......................................C............',
      '............^^^^..................^^^^........................................^^^^................................',
      '....########.................#########.............###########.........#########................................',
      '#########################....###############################....#############################....################'
    ],
    movingPlatforms: [
      {
        id: 'mp-2-1',
        x: 620,
        y: 86,
        w: 40,
        h: 10,
        minX: 560,
        maxX: 760,
        speed: 35,
        dir: 1 as const,
      }
    ]
  },
  {
    name: 'Sky Forge',
    timeTarget: 100,
    map: [
      '....................................................................................................................',
      '....................................................................................................................',
      '......C....................S....................C...................C..............................................',
      '..P..........####........................####...................#####.................................####.......X..',
      '....................E....................................H........................E..................................',
      '########.........C.............####............C.........................####.......................................',
      '.......................####.........................####.........................................C...................',
      '.......^^^^......................^^^^..........................^^^^..............................^^^^................',
      '....##########..........##############..........##############..........##############..............................',
      '#####################....#####################....#####################....#########################################'
    ],
    movingPlatforms: [
      {
        id: 'mp-3-1',
        x: 460,
        y: 74,
        w: 44,
        h: 10,
        minX: 430,
        maxX: 620,
        speed: 48,
        dir: 1 as const,
      }
    ]
  }
];

export const LEVELS: LevelDefinition[] = levelAscii.map((raw, idx) => {
  const parsed = fromAscii(raw.map);
  return {
    id: idx + 1,
    name: raw.name,
    width: raw.map[0].length,
    height: raw.map.length,
    timeTarget: raw.timeTarget,
    movingPlatforms: raw.movingPlatforms,
    ...parsed
  };
});
